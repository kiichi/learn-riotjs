<app>
    <div class="row">
        <div class="column column-20">
            <h2>{state.structure.Title}</h2>
            <ol>
                <li each="{chapter in state.structure.Chapters}" if="{chapter.Type === 'Chapter'}">
                    <a href="#" onclick="{()=>menuClicked(chapter)}">{chapter.Title}</a>
                    <ol if="{chapter.Sections.length > 1}">
                        <li each="{section in chapter.Sections}">
                            <a href="#" onclick="{()=>menuClicked(section)}">{section.Title}</a>
                        </li>
                    </ol>
                </li>
            </ol>
            <hr/>
            <p class="copyright">
                Copyright
                Â©
                {state.structure.Meta ? state.structure.Meta.Year : ''} <br/>
                {state.structure.Meta ? state.structure.Meta.Author : ''},
                All rights reserved
            </p>
        </div>
        <div class="column">
            <content md="{state.src}"></content>
            <hr/>
            <button class="button button-outline button-small float-right" onclick="{(()=>downloadPdf(state.src))}">&#128462; Download PDF (Beta)</button>
        </div>
    </div>
    <script>
        export default {
            state: {
                src: '', //
                structure:[]
            },
            async onMounted(){
                this.state.structure = await this.service.getStructure();
                await this.loadChapter(this.state.structure.Chapters[5]);
                this.update();

                this.pdf.setMetaData(this.state.structure.Title,
                                    this.state.structure.Meta.Author,
                                    this.state.structure.Meta.Subject,
                                    this.state.structure.Meta.Keywords);
            },
            async menuClicked(chapter){
                await this.loadChapter(chapter);
                this.update();
            },
            async loadChapter(node){
                console.log(node)
                if (node.Type === 'Chapter'){
                    this.state.src = await this.publisher.getSource(node.Sections[0].Contents);
                }
                else {
                    this.state.src = await this.publisher.getSource(node.Contents);
                }
            },
            downloadPdf(source){
                // testing...
                const html = this.publisher.getHtml(source);

                // hljs.configure({
                //     tabReplace:'<span class="rbook-indent">    </span>'
                // });

                var elem = document.createElement('html');
                elem.innerHTML = html;
                elem.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
                console.log(elem);
                this.pdf.download(elem.innerHTML);
            }
        }
    </script>
</app>